pkgbase='couldinho'
pkgname=(couldinho-base couldinho-desktop couldinho-laptop couldinho-dev couldinho-sec couldinho-vmware)
pkgver=2
pkgrel=24
pkgdesc="Packages for couldinho systems"
arch=(x86_64)
url="https://github.com/kontax/arch-packages"
license=(MIT)
groups=(couldinho)

source=(conf-files.tar.xz)
sha256sums=(2c6cef289100e74b98a14e26332357329a22e19ce8313d8720bca6b015963b71)

# Comment for update

package_couldinho-base() {
    install=couldinho-base.install

    install -Dm 0644 base/etc/profile.d/couldinho-base.sh "$pkgdir/etc/profile.d/couldinho-base.sh"

    # base
    depends=(
        bash
        bzip2
        coreutils
        device-mapper
        dhcpcd
        diffutils
        e2fsprogs
        file
        filesystem
        findutils
        gawk
        gcc-libs
        gettext
        glibc
        grep
        gzip
        inetutils
        iproute2
        iputils
        less
        licenses
        linux
        linux-firmware
        logrotate
        man-db
        man-pages
        mdadm
        netctl
        pacman
        pciutils
        perl
        procps-ng
        psmisc
        s-nail
        sed
        shadow
        sysfsutils
        systemd-sysvcompat
        tar
        texinfo
        usbutils
        util-linux
        which
    )

    # base-devel
    depends+=(
        autoconf
        automake
        binutils
        bison
        fakeroot
        flex
        gcc
        groff
        libtool
        m4
        make
        patch
        pkgconf
        sudo
        systemd
    )

    install -Dm 0644 base/etc/mkinitcpio.conf "$pkgdir/etc/couldinho-mkinitcpio.conf"
    install -Dm 0644 base/etc/pacman.conf "$pkgdir/etc/couldinho-pacman.conf"
    install -Dm 0644 base/etc/pacman.d/couldinho-arch-aur "$pkgdir/etc/pacman.d/couldinho-arch-aur"
    install -Dm 0400 base/etc/sudoers "$pkgdir/etc/couldinho-sudoers"
    install -Dm 0644 base/etc/vimrc "$pkgdir/etc/couldinho-vimrc"
    install -Dm 0644 base/etc/vconsole.conf "$pkgdir/etc/vconsole.conf"
    install -Dm 0644 base/usr/share/kbd/keymaps/i386/qwerty/jc.map.gz \
                "$pkgdir/usr/share/kbd/keymaps/i386/qwerty/jc.map.gz"

    # Boot and base progs
    depends+=(
        cryptboot           # Encrypted partitions
        mkinitcpio-encrypt-detached-header # Encrypt hook with detatched header
        arch-secure-boot    # UEFI Secure Boot
        intel-ucode         # Microcode patches
        fwupd               # Firmware updater
        terminus-font       # Better font for console
        git                 # Move to devel?
        cifs-utils          # Connect to shared drives
        stow                # Link dotfiles to home dir
        neovim              # Vim replacement
        python-pynvim       # Python modules for neovim
        nodejs              # JS dev for use in coc.vim #TODO: Move to dev
        npm                 # Node package manager
    )

    install -Dm 0644 base/etc/gitconfig "$pkgdir/etc/gitconfig"
    install -Dm 0644 base/etc/xdg/nvim/init.vim "$pkgdir/etc/xdg/nvim/init.vim"
    install -Dm 0644 base/etc/xdg/nvim/bootstrap.vim \
        "$pkgdir/etc/xdg/nvim/bootstrap.vim"
    install -Dm 0644 base/etc/xdg/nvim/plugins.vim \
        "$pkgdir/etc/xdg/nvim/plugins.vim"
    install -dm 0775 "$pkgdir/etc/xdg/nvim/autoload"
    cp -r base/etc/xdg/nvim/modules "$pkgdir/etc/xdg/nvim/modules"

    # Base replacements
    depends+=(
        exa                 # ls replacement
        ripgrep             # Fuzzy search
        ripgrep-all         # ripgrep wrapper for multiple file types
        rmtrash             # Delete to bin
        bat                 # Cat replacement with syntax highlighting
    )

    install -dm 0755 base/etc/bat "$pkgdir/etc/bat"

    # Networking + VPN
    depends+=(
        networkmanager              # Networking
        networkmanager-strongswan   # IPSEC VPN
        iw                          # Move to laptop?
        wget openssh                # Download and connect
        openvpn                     # Connect to PIA
        networkmanager-openvpn      # NetworkManager drivers for OpenVPN
        gnu-netcat                  # GNU netcat - contains -e for executables
        #openbsd-netcat             # OpenBSD netcat #TODO: Find a way to install both
        socat                       # Similar to netcat
        bandwhich                   # Terminal bandwith utilization tool
        croc                        # Send files securely to another computer
    )

    # Shell
    depends+=(
        zsh                 # Better shell
        direnv              # Shell extension managing environment
        fzy                 # Fzy text selector
        lscolors-git        # Colours for ls
        dfrs                # Colourised version of df
        tmux                # Terminal multiplexer
    )

    install -Dm 0644 base/etc/zsh/zshrc "$pkgdir/etc/zsh/couldinho-zshrc"
    install -Dm 0644 base/etc/zsh/p10k.zsh "$pkgdir/etc/zsh/couldinho-p10k.zsh"
    install -Dm 0644 base/etc/zsh/zprofile "$pkgdir/etc/zsh/couldinho-zprofile"
    install -Dm 0644 base/etc/zsh/zsh-aliases "$pkgdir/etc/zsh/couldinho-zsh-aliases"
    install -Dm 0644 base/etc/zsh/zshenv "$pkgdir/etc/zsh/couldinho-zshenv"

    # Filesystem
    depends+=(
        btrfs-progs         # BTRFS filesystem tools
        snapper             # Snapshot manager
        snap-pac            # Hooks for pacman for auto-snapshotting
        zip                 # Zipping tool
        unzip               # Unzipping tool
    )

    install -Dm 0644 base/etc/conf.d/snapper "$pkgdir/etc/conf.d/couldinho-snapper"
    install -Dm 0644 base/etc/snapper/configs/root "$pkgdir/etc/snapper/configs/root"
    install -Dm 0644 base/etc/snap-pac.conf "$pkgdir/etc/snap-pac.conf"

    # Access Control + Security
    depends+=(
        pass                # Text-based password manager
        pass-git-helper     # Credential helper using pass to store details
        usbguard            # USB security configuration
        yubikey-manager     # Yubikey settings
        yubico-pam          # PAM settings for yubikey
        libu2f-server       # Libraries for U2F - login with yubikey
        pam-u2f             # Login to system with U2F
        git-secret          # Helper tool for storing private files in a git repo
        arch-audit          # View security details of arch packages
    )

    install -Dm 0644 base/etc/profile.d/zz_custom.sh "$pkgdir/etc/profile.d/zz_custom.sh"
    install -Dm 0644 base/etc/pacman.d/hooks/arch-audit.hook "$pkgdir/etc/pacman.d/hooks/arch-audit.hook"
    install -dm 0750 base/etc/usbguard "$pkgdir/etc/usbguard"
    install -Dm 0600 base/etc/usbguard/usbguard-daemon.conf \
        "$pkgdir/etc/usbguard/couldinho-usbguard-daemon.conf"

    # Packages
    depends+=(
        devtools            # Package building helpers
        aurutils-git        # AUR helper
        pacman-contrib      # Contains checkupdates plus other pacman scripts
        reflector           # Automatically sort out pacman mirrorlist
        urlwatch            # Tool for monitoring webpage updates
        python-chump-git    # Pushover dependency for urlwatch
    )

    install -Dm 0644 base/etc/systemd/system/reflector.service "$pkgdir/etc/systemd/system/reflector.service"
    install -Dm 0644 base/etc/systemd/system/reflector.timer "$pkgdir/etc/systemd/system/reflector.timer"
}

package_couldinho-desktop() {
    install=couldinho-desktop.install

    install -Dm 0644 desktop/etc/profile.d/couldinho-desktop.sh "$pkgdir/etc/profile.d/couldinho-desktop.sh"

    # base
    depends=(
        couldinho-base
    )

    # backend
    depends+=(
        xorg-xwayland           # X server
        qt5-wayland             # QT API's for Wayland
        vulkan-intel            # Intel Vulkan mesa driver #TODO: Is this required?
        vulkan-headers          # Vulkan header files
    )

    install -Dm 0644 desktop/etc/X11/xorg.conf.d/00-keyboard.conf \
                    "$pkgdir/etc/X11/xorg.conf.d/00-keyboard.conf"
    install -Dm 0644 desktop/usr/share/X11/xkb/symbols/jc "$pkgdir/usr/share/X11/xkb/symbols/jc"

    # sway
    depends+=(
        sway                    # Tiling wayland compositor replacing i3
        swaylock                # Lock wayland screen
        wl-clipboard            # Wayland command-line clipboard manager
        python-i3ipc            # IPC for i3 via python
        waybar                  # Sway bar for wayland
        slurp                   # Region selector for wayland
        swayr                   # Window switcher for sway
        swaync                  # Sway notification daemon
        wldash                  # Wayland launcher and dashboard
    )

    install -Dm 0644 desktop/etc/sway/config "$pkgdir/etc/sway/couldinho-desktop-config"
    install -Dm 0644 desktop/usr/share/fonts/taskbar.ttf "$pkgdir/usr/share/fonts/taskbar.ttf"
    install -Dm 0644 desktop/etc/X11/xorg.conf.d/00-keyboard.conf \
                    "$pkgdir/etc/X11/xorg.conf.d/00-keyboard.conf"
    install -Dm 0644 desktop/usr/share/X11/xkb/symbols/jc "$pkgdir/usr/share/X11/xkb/symbols/jc"
    install -Dm 0644 desktop/etc/xdg/waybar/config "$pkgdir/etc/xdg/waybar/coudlinho-desktop-config"
    install -Dm 0644 desktop/etc/xdg/waybar/style.css "$pkgdir/etc/xdg/waybar/couldinho-desktop-style.css"

    # Further sway packages
    depends+=(
        flashfocus-git          # Focus animations
        qalculate-gtk           # Calculator
        ttf-inconsolata         # Font for terminal and status etc.
        otf-font-awesome        # Font with icons
        python-tzlocal          # Used within the clock for the status bar
        gsimplecal              # GTK calendar for the status bar
        inotify-tools           # Interface to inotify
        yubikey-touch-detector  # i3status notification for when yubikey needs attention 
        pinentry                # Enter GPG pins using dmenu
    )

    #install -Dm 0644 desktop/etc/rofi.rasi "$pkgdir/etc/rofi.rasi"
    install -Dm 0644 desktop/etc/xdg/flashfocus/flashfocus.yml "$pkgdir/etc/xdg/flashfocus/couldinho-desktop-flashfocus.yml"

    # Multimedia
    depends+=(
        alsa-utils              # Sound support
        pulseaudio              # Sound server
        pulseaudio-alsa         # ALSA config for pulseaudio
        pamixer                 # Command line mixer
        vimiv                   # Image viewer with vim bindings
    )

    # Documents
    depends+=(
        zathura                 # PDF viewer with vim bindings
        zathura-pdf-mupdf       # MuPDF plugin for zathura
    )

    # Terminal + desktop tools
    depends+=(
        kitty                   # GPU enhanced terminal emulator
        #flameshot               # Screenshot tool
        #copyq                   # Copy/Paste utility
        #unclutter               # Hide mouse in i3 when not in use
        #ranger                  # File manager from terminal (vim keybindings)
        python-pillow           # Used to view pictures within ranger
        freerdp                 # Remote desktop client
        #xsecurelock             # Desktop lock screen
    )

    install -Dm 0644 desktop/etc/xdg/kitty/diff.conf "$pkgdir/etc/xdg/kitty/diff.conf"
    install -Dm 0644 desktop/etc/xdg/kitty/kitty.conf "$pkgdir/etc/xdg/kitty/kitty.conf"
    install -Dm 0644 desktop/etc/xdg/kitty/vm.py "$pkgdir/etc/xdg/kitty/vm.py"
    #install -Dm 0644 desktop/etc/xdg/picom.conf "$pkgdir/etc/xdg/couldinho-picom.conf"

    # Networking
    #depends+=(
    #    nm-connection-editor        # Gui tool for managing NetworkManager connections
    #    networkmanager-dmenu-git    # dmenu for NetworkManager connections
    #)

    # Web
    depends+=(
        vivaldi                 # Browser
        vivaldi-ffmpeg-codecs   # Browser video codecs
        vivaldi-widevine        # Stream DRM support for vivaldi
        pepper-flash            # Flash player
        x265                    # Video compression
        browserpass-chromium    # Browser extenson for pass
    )

    # General scripts
    install -Dm 0755 desktop/usr/local/bin/check-aur-became-official "$pkgdir/usr/local/bin/check-aur-became-official"
    #install -Dm 0755 desktop/usr/local/bin/i3-autoname-workspaces "$pkgdir/usr/local/bin/i3-autoname-workspaces"
    #install -Dm 0755 desktop/usr/local/bin/i3exit "$pkgdir/usr/local/bin/i3exit"
    install -Dm 0755 desktop/usr/local/bin/is_online "$pkgdir/usr/local/bin/is_online"
    install -Dm 0755 desktop/usr/local/bin/rdp "$pkgdir/usr/local/bin/rdp"
    install -Dm 0755 desktop/usr/local/bin/renumber-sessions "$pkgdir/usr/local/bin/renumber-sessions"
    #install -Dm 0755 desktop/usr/local/bin/rofi-calc "$pkgdir/usr/local/bin/rofi-calc"
    #install -Dm 0755 desktop/usr/local/bin/set-brightness "$pkgdir/usr/local/bin/set-brightness"
}

package_couldinho-dev() {
    install=couldinho-dev.install

    # No dotfile scripts are installed here - use the next dependency
    #install -Dm 0644 dev/etc/profile.d/couldinho-dev.sh "$pkgdir/etc/profile.d/couldinho-dev.sh"

    depends=(
        couldinho-base
        couldinho-desktop
    )

    # Platforms/Languages
    depends+=(
        docker                  # Containerisation
        docker-compose          # Docker dev management
        docker-credential-pass  # Store and use docker credentials from pass
        rust                    # The rust programming language and tools
        rustup                  # Rust toolchain installer
        nasm                    # x86 Assembler
        ipython                 # iPython Notebooks
    )

    # IDE's
    depends+=(
        pycharm-professional    # Python IDE by JetBrains
    )

    # Debugging
    depends+=(
        gdb                     # GNU debugger
        rr                      # Replaying debugger
    )

    # Cloud
    depends+=(
        aws-cli                 # Command line interface to AWS
        aws-sam-cli             # Client for AWS SAM serverless
        npm                     # Node package manager (used for serverless)
    )
}

package_couldinho-sec() {
    install=couldinho-sec.install

    # No dotfile scripts are installed here - use the next dependency
    #install -Dm 0644 sec/etc/profile.d/couldinho-sec.sh "$pkgdir/etc/profile.d/couldinho-sec.sh"

    depends=(
        couldinho-desktop
    )

    # Binary
    depends+=(
        010editor               # Binary editor with templates
        ltrace                  # Trace library calls
        strace                  # Trace system calls and signals
        binwalk                 # Find and extract file types within a file
    )

    # Network
    depends+=(
        nmap                    # Network mapper
        wireshark-cli           # Network analyzer - CLI tools
        wireshark-qt            # Network analyzer - GUI
        burpsuite               # Security testing web applications
        dirbuster               # Brute force directories and filenames
        wfuzz                   # Brute force web applications
    )

    # Debugging
    depends+=(
        pwndbg                  # Enhance GDB, similar to GEF
        gef-git                 # GDB Enhanced Features
        pwngdb                  # GDB for pwn
    )

    # Reversing
    depends+=(
        radare2                 # Command line reverse engineering framework
        ida-free                # Hexrays reversen engineering framework
        ghidra                  # Reverse engineering framework similar to IDA
        python-capstone         # GEF optional dependency
        python-unicorn          # GEF optional dependency
        python-keystone         # GEF optional dependency
        python-ropper           # GEF optional dependency
    )

    # Cracking
    depends+=(
        john                    # John the Ripper password cracker
    )
}

package_couldinho-laptop() {
    install=couldinho-laptop.install

    install -Dm 0644 laptop/etc/profile.d/couldinho-laptop.sh "$pkgdir/etc/profile.d/couldinho-laptop.sh"

    # base + desktop
    depends=(
        couldinho-desktop
    )

    # Laptop specific programs
    depends+=(
        light                   # Program to change backlight
    )

    # Overwrite desktop files
    install -Dm 0644 laptop/etc/i3status.conf "$pkgdir/etc/couldinho-laptop-i3status.conf"
    install -Dm 0644 laptop/etc/i3/config "$pkgdir/etc/i3/couldinho-laptop-config"
    install -Dm 0644 laptop/etc/lightdm/lightdm-gtk-greeter.conf \
        "$pkgdir/etc/lightdm/couldinho-laptop-lightdm-gtk-greeter.conf"
    #install -Dm 0644 laptop/etc/rofi.rasi "$pkgdir/etc/couldinho-laptop-rofi.rasi"
    install -Dm 0644 laptop/etc/xdg/kitty/kitty.conf "$pkgdir/etc/xdg/kitty/couldinho-laptop-kitty.conf"
    install -Dm 0644 laptop/usr/share/X11/xorg.conf.d/40-libinput.conf \
        "$pkgdir/usr/share/X11/xorg.conf.d/couldinho-laptop-40-libinput.conf"
}

package_couldinho-vmware() {
    install=couldinho-vmware.install

    # base + desktop
    depends=(
        couldinho-desktop
    )

    # VMWare specific programs
    depends+=(
        light                   # Program to change backlight
        open-vm-tools           # Open source version of VMWare Tools
        xf86-input-vmmouse      # VMWare mouse driver
        xf86-video-vmware       # VMWare video driver
        gtkmm3                  # C++ bindings for GTK+ 3 - used for VMWare copy/paste
    )

    install -Dm 0644 vmware/etc/i3/config "$pkgdir/etc/i3/couldinho-vmware-config"
    install -Dm 0644 vmware/etc/zsh/zprofile "$pkgdir/etc/zsh/couldinho-vmware-zprofile"

}
